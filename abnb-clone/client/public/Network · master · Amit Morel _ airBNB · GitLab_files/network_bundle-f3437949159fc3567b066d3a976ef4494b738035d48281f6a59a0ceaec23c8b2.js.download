(function(){var t=function(t,e){return function(){return t.apply(e,arguments)}};this.BranchGraph=function(){function e(e,i){this.element=e,this.options=i,this.scrollTop=t(this.scrollTop,this),this.scrollBottom=t(this.scrollBottom,this),this.scrollRight=t(this.scrollRight,this),this.scrollLeft=t(this.scrollLeft,this),this.scrollUp=t(this.scrollUp,this),this.scrollDown=t(this.scrollDown,this),this.preparedCommits={},this.mtime=0,this.mspace=0,this.parents={},this.colors=["#000"],this.offsetX=150,this.offsetY=20,this.unitTime=30,this.unitSpace=10,this.prev_start=-1,this.load()}return e.prototype.load=function(){return $.ajax({url:this.options.url,method:"get",dataType:"json",success:$.proxy(function(t){return $(".loading",this.element).hide(),this.prepareData(t.days,t.commits),this.buildGraph()},this)})},e.prototype.prepareData=function(t,e){var i,s,r,o,h,n;for(this.days=t,this.commits=e,this.collectParents(),this.graphHeight=$(this.element).height(),this.graphWidth=$(this.element).width(),s=Math.max(this.graphHeight,this.offsetY+this.unitTime*this.mtime+150),r=Math.max(this.graphWidth,this.offsetX+this.unitSpace*this.mspace+300),this.r=Raphael(this.element.get(0),r,s),this.top=this.r.set(),this.barHeight=Math.max(this.graphHeight,this.unitTime*this.days.length+320),n=this.commits,o=0,h=n.length;h>o;o++)i=n[o],i.id in this.parents&&(i.isParent=!0),this.preparedCommits[i.id]=i,this.markCommit(i);return this.collectColors()},e.prototype.collectParents=function(){var t,e,i,s,r,o;for(r=this.commits,o=[],e=0,i=r.length;i>e;e++)t=r[e],this.mtime=Math.max(this.mtime,t.time),this.mspace=Math.max(this.mspace,t.space),o.push(function(){var e,i,r,o;for(r=t.parents,o=[],e=0,i=r.length;i>e;e++)s=r[e],this.parents[s[0]]=!0,o.push(this.mspace=Math.max(this.mspace,s[1]));return o}.call(this));return o},e.prototype.collectColors=function(){var t,e;for(t=0,e=[];t<this.mspace;)this.colors.push(Raphael.getColor(.8)),Raphael.getColor(),Raphael.getColor(),e.push(t++);return e},e.prototype.buildGraph=function(){var t,e,i,s,r,o,h,n;for(h=this.r,t=0,e="",h.rect(0,0,40,this.barHeight).attr({fill:"#222"}),h.rect(40,0,30,this.barHeight).attr({fill:"#444"}),n=this.days,o=s=0,r=n.length;r>s;o=++s)i=n[o],(t!==i[0]||e!==i[1])&&(h.text(55,this.offsetY+this.unitTime*o,i[0]).attr({font:"12px Monaco, monospace",fill:"#BBB"}),t=i[0]),e!==i[1]&&(h.text(20,this.offsetY+this.unitTime*o,i[1]).attr({font:"12px Monaco, monospace",fill:"#EEE"}),e=i[1]);return this.renderPartialGraph(),this.bindEvents()},e.prototype.renderPartialGraph=function(){var t,e,i,s,r,o,h;if(r=Math.floor((this.element.scrollTop()-this.offsetY)/this.unitTime)-10,0>r&&(s=!0,r=0),e=r+40,this.commits.length<e&&(s=!0,e=this.commits.length),-1===this.prev_start||Math.abs(this.prev_start-r)>10||s){for(i=r,this.prev_start=r;e>i;)t=this.commits[i],i+=1,t.hasDrawn!==!0&&(o=this.offsetX+this.unitSpace*(this.mspace-t.space),h=this.offsetY+this.unitTime*t.time,this.drawDot(o,h,t),this.drawLines(o,h,t),this.appendLabel(o,h,t),this.appendAnchor(o,h,t),t.hasDrawn=!0);return this.top.toFront()}},e.prototype.bindEvents=function(){var t;return t=this.element,$(t).scroll(function(t){return function(e){return t.renderPartialGraph()}}(this))},e.prototype.scrollDown=function(){return this.element.scrollTop(this.element.scrollTop()+50),this.renderPartialGraph()},e.prototype.scrollUp=function(){return this.element.scrollTop(this.element.scrollTop()-50),this.renderPartialGraph()},e.prototype.scrollLeft=function(){return this.element.scrollLeft(this.element.scrollLeft()-50),this.renderPartialGraph()},e.prototype.scrollRight=function(){return this.element.scrollLeft(this.element.scrollLeft()+50),this.renderPartialGraph()},e.prototype.scrollBottom=function(){return this.element.scrollTop(this.element.find("svg").height())},e.prototype.scrollTop=function(){return this.element.scrollTop(0)},e.prototype.appendLabel=function(t,e,i){var s,r,o,h,n,a,l;if(i.refs)return r=this.r,h=i.refs,h.length>17&&(h=h.substr(0,15)+"\u2026"),n=r.text(t+4,e,h).attr({"text-anchor":"start",font:"10px Monaco, monospace",fill:"#FFF",title:i.refs}),a=n.getBBox(),o=r.rect(t,e-7,a.width+5,a.height+5,4).attr({fill:"#000","fill-opacity":.5,stroke:"none"}),l=r.path(["M",t-5,e,"L",t-15,e-4,"L",t-15,e+4,"Z"]).attr({fill:"#000","fill-opacity":.5,stroke:"none"}),s=r.set(o,n),s.transform(["t",-o.getBBox().width-15,0]),n.toFront()},e.prototype.appendAnchor=function(t,e,i){var s,r,o,h;return o=this.r,h=this.top,r=this.options,s=o.circle(t,e,10).attr({fill:"#000",opacity:0,cursor:"pointer"}).click(function(){return window.open(r.commit_url.replace("%s",i.id),"_blank")}).hover(function(){return this.tooltip=o.commitTooltip(t+5,e,i),h.push(this.tooltip.insertBefore(this))},function(){return this.tooltip&&this.tooltip.remove()&&delete this.tooltip}),h.push(s)},e.prototype.drawDot=function(t,e,i){var s,r,o;return o=this.r,o.circle(t,e,3).attr({fill:this.colors[i.space],stroke:"none"}),s=this.offsetX+this.unitSpace*this.mspace+10,r=e-10,o.rect(s,r,20,20).attr({stroke:this.colors[i.space],"stroke-width":2}),o.image(i.author.icon,s,r,20,20),o.text(this.offsetX+this.unitSpace*this.mspace+35,e,i.message.split("\n")[0]).attr({"text-anchor":"start",font:"14px Monaco, monospace"})},e.prototype.drawLines=function(t,e,i){var s,r,o,h,n,a,l,p,c,f,m,u,g,d,w;for(u=this.r,g=i.parents,d=[],o=h=0,n=g.length;n>h;o=++h)l=g[o],p=this.preparedCommits[l[0]],m=this.offsetY+this.unitTime*p.time,c=this.offsetX+this.unitSpace*(this.mspace-p.space),f=this.offsetX+this.unitSpace*(this.mspace-l[1]),r=p.space<=i.space?this.colors[i.space]:this.colors[p.space],l[1]===i.space?(a=[0,5],s="l-2,5,4,0,-2,-5,0,5"):l[1]<i.space?(a=[3,3],s="l5,0,-2,4,-3,-4,4,2"):(a=[-3,3],s="l-5,0,2,4,3,-4,-4,2"),w=["M",t+a[0],e+a[1]],o>0&&w.push(s),(i.space!==p.space||i.space!==l[1])&&w.push("L",f,e+10,"L",f,m-5),w.push("L",c,m),d.push(u.path(w).attr({stroke:r,"stroke-width":2}));return d},e.prototype.markCommit=function(t){var e,i,s;return t.id===this.options.commit_id?(e=this.r,i=this.offsetX+this.unitSpace*(this.mspace-t.space),s=this.offsetY+this.unitTime*t.time,e.path(["M",i+5,s,"L",i+15,s+4,"L",i+15,s-4,"Z"]).attr({fill:"#000","fill-opacity":.5,stroke:"none"}),this.element.scrollTop(s-this.graphHeight/2)):void 0},e}(),Raphael.prototype.commitTooltip=function(t,e,i){var s,r,o,h,n,a,l,p,c;return r=300,s=200,o=this.image(gon.relative_url_root+i.author.icon,t,e,20,20),a=this.text(t+25,e+10,i.author.name),h=this.text(t,e+35,i.id),n=this.text(t,e+50,i.message.replace(/\r?\n/g," \n ")),p=this.set(o,a,h,n).attr({"text-anchor":"start",font:"12px Monaco, monospace"}),a.attr({font:"14px Arial","font-weight":"bold"}),h.attr({fill:"#AAA"}),n.node.style["white-space"]="pre",this.textWrap(n,r-50),l=this.rect(t-10,e-10,r,100,4).attr({fill:"#FFF",stroke:"#000","stroke-linecap":"round","stroke-width":2}),c=this.set(l,p),l.attr({height:c.getBBox().height+10,width:c.getBBox().width+10}),c.transform(["t",20,20]),c},Raphael.prototype.textWrap=function(t,e){var i,s,r,o,h,n,a,l,p,c,f;for(r=t.attr("text"),i="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",t.attr({text:i}),a=t.getBBox().width/i.length,t.attr({text:r}),c=r.split(" "),f=0,l=[],h=0,n=c.length;n>h;h++)p=c[h],f+p.length*a>e&&(l.push("\n"),f=0),"\n"===p?(l.push("\n"),f=0):(l.push(p+" "),f+=p.length*a);return t.attr({text:l.join("").trim()}),s=t.getBBox(),o=Math.abs(s.y2)+1,t.attr({y:o})}}).call(this),function(){this.Network=function(){function t(t){var e;$("#filter_ref").click(function(){return $(this).closest("form").submit()}),this.branch_graph=new BranchGraph($(".network-graph"),t),e=$(window).height()-250,$(".network-graph").css({height:e+"px"})}return t}()}.call(this),function(){$(function(){if($(".network-graph").length){var t;return t=new Network({url:$(".network-graph").attr("data-url"),commit_url:$(".network-graph").attr("data-commit-url"),ref:$(".network-graph").attr("data-ref"),commit_id:$(".network-graph").attr("data-commit-id")}),new ShortcutsNetwork(t.branch_graph)}})}.call(this);